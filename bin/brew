#!/usr/bin/ruby
$:.unshift ENV['RUBYLIB']=File.expand_path(__FILE__+'/../../Library/Homebrew')

require 'pathname+yeast'
require 'ARGV+yeast'
require 'utils'
require 'brew.h'

# TODO if whoami == root then use /Library/Caches/Homebrew instead
HOMEBREW_CACHE=Pathname.new("~/Library/Caches/Homebrew").expand_path
HOMEBREW_PREFIX=Pathname.new(__FILE__).dirname.parent.cleanpath
HOMEBREW_CELLAR=HOMEBREW_PREFIX+'Cellar'
HOMEBREW_VERSION='0.4'
HOMEBREW_WWW='http://bit.ly/Homebrew'
HOMEBREW_USER_AGENT="Homebrew #{HOMEBREW_VERSION} (Ruby #{VERSION}; Mac OS X 10.5 Leopard)"

if %w[/ /usr].include? HOMEBREW_PREFIX.to_s then abort <<-troba
You have placed Homebrew at the prefix: #{HOMEBREW_PREFIX}
This is not currently supported. Voice your support for this feature at:
#{HOMEBREW_WWW}
troba
end

# Pathname often throws if CWD doesn't exist
Dir.chdir '/' unless File.directory? ENV['PWD']


begin
  case ARGV.shift
    when '--prefix' then puts HOMEBREW_PREFIX
    when '--cache' then puts HOMEBREW_CACHE
    when '-h', '--help', '--usage', '-?' then puts ARGV.usage
    when '-v', '--version' then puts HOMEBREW_VERSION

    when 'home', 'homepage'
      if ARGV.named.empty?
        exec "open", HOMEBREW_WWW
      else
        exec "open", *ARGV.formulae.collect {|f| f.homepage}
      end

    when 'ls', 'list'
      exec "find", *ARGV.kegs.concat(%w[-not -type d -print])

    when 'edit'
      if ARGV.empty?
        exec "mate", *Dir["#{HOMEBREW_PREFIX}/Library/*"]<<
                          "#{HOMEBREW_PREFIX}/bin/brew"<<
                          "#{HOMEBREW_PREFIX}/README"
      else
        exec "mate", *ARGV.formulae.collect {|f| f.path}
      end

    when 'install'
      require 'keg'
      ARGV.formulae.each do |f|
        raise "#{f.name} is already installed" if f.installed? unless ARGV.force?
        start_time=Time.now
        begin
          install f
          if f.caveats
            ohai "Caveats"
            puts f.caveats
            puts
          end
          ohai 'Finishing up'
          clean f
          raise "Nothing was installed to #{f.prefix}" unless f.installed?
          Keg.new(f.prefix).link
        rescue
          f.prefix.rmtree if f.prefix.directory?
          raise
        end
        puts "#{f.prefix}: "+f.prefix.abv+", built in #{pretty_duration Time.now-start_time}"
      end

    when 'ln', 'link'
      ARGV.kegs.each {|keg| puts "#{keg.link} links created for #{keg}"}

    when 'unlink'
      ARGV.kegs.each {|keg| puts "#{keg.unlink} links removed for #{keg}"}

    when 'rm', 'uninstall', 'remove'
      ARGV.kegs.each do |keg|
        puts "Uninstalling #{keg}..."
        keg.uninstall
      end
      prune

    when 'up', 'update'
      puts "Reserved command"

    when 'prune'
      prune

    when 'mk', 'make'
      if ARGV.include? '--macports'
        exec "open", "http://www.macports.org/ports.php?by=name&substr=#{ARGV.next}"
      else
        exec "mate", *ARGV.named.collect {|name| make name}
      end

    when 'info', 'abv'
      if ARGV.named.empty?
        puts `ls #{HOMEBREW_CELLAR} | wc -l`.strip+" kegs, "+HOMEBREW_CELLAR.abv
      elsif ARGV[0][0..6] == 'http://'
        puts Pathname.new(ARGV.shift).version
      else
        ARGV.named.each {|name| info name}
      end

    else
      puts ARGV.usage
  end

rescue SystemExit
  ohai "Kernel.exit" if ARGV.verbose?
rescue Interrupt => e
  puts # seemingly a newline is typical
  exit 130
rescue SystemCallError, RuntimeError => e
  if ARGV.verbose? or ARGV.debug?
    onoe e.inspect
    puts e.backtrace
  else
    onoe e
  end
  exit 1
rescue Exception => e
  onoe "Homebrew has failed you :("
  puts "Please report this bug at: #{HOMEBREW_WWW}"
  puts "Please include this backtrace:"
  ohai e.inspect
  puts e.backtrace
end
