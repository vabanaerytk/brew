#!/usr/bin/ruby
# Copyright 2009 Max Howell <max@methylblue.com>
# Licensed as per the GPL version 3
require 'find'
require 'pathname'
$root = Pathname.new(__FILE__).realpath.dirname.parent.parent

case ARGV[0]
  when 'brew', 'install' then
    file="#{$root}/Formula/#{ARGV[1]}"
    file+='.rb' unless File.exist? file
    system "ruby #{file}"

  when 'ln' then
    abort "#{ARGV[1]} is not a directory" unless File.directory? ARGV[1]

    #TODO if user specifies just name and not version dir, do latest version
    #TODO you should mkdirs as you find them and symlink files otherwise
    #TODO consider using hardlinks

    target=Pathname.new(ARGV[1]).realpath
    target.find do |from|
      next if from == ARGV[1] #rubysucks

      to=$root+from.relative_path_from(target)

      if from.directory?
        to.mkpath unless to.exist?
      elsif from.file?
        tod=to.dirname
        Dir.chdir(tod) { `ln -s "#{from.relative_path_from tod}"` }
      end
    end

  when 'prune', 'pasteurize' then
    $root.find do |path| 
      if path.directory?
        name=path.basename
        Find.prune if name == 'Cellar' or name == 'Formula'
      elsif path.symlink?
        path.unlink unless path.readlink.exist?
      end
    end

  else
    puts "usage: #{$0} [prune] [ln path] [install pkg]"
end